#Todo List App (React/Redux/NodeJS)

##Архитектура приложения

```
.
+-- api                    //Backend API-сервер
|   +-- migrations         //Миграции для [Sequelize-ORM](http://docs.sequelizejs.com/en/v3/) для PostgreSQL
|   +-- models             //Модели (Sequelize ORM)
|   |   +-- todo.js
|   |   +-- user.js
|   +-- routes              //Роуты API-сервера, по архитектуре близки к REST
|   |   +-- sessions.js
|   |   +-- todos.js
|   |   +-- users.js
|   |   +-- verify.js       //Генерация и верификация токенов, используется в роутах
|   +-- seeders
|   +-- config.json         //Конфигурационный файл для базы данных (postgres)
|   +-- server.config.json  //Конфигурационный файл для api-сервера
    |                       //(хранится секретный ключ для JSON Web Token)
|   +-- server.js           //Непосредственно API-server (express app)
|
|
+-- app                     //Middle-end сервер
|   +-- routes              //Роуты промежуточного сервера, также REST
|   |   +-- index.js        //Роут, срабатывающий, когда пользователь запрашивает
|   |   |                   //Страницу по http. Проверяет, авторизован ли пользователь
|   |   |                   //И отдаёт шаблон из view и начальное состоние, зависящее
|   |   |                   //От результата проверки
|   |   +-- sessions.js     //Роут сессий, 'общается' с фронтендом через JSON
|   |   +-- todos.js        //Роут 'дел', --//--
|   |   +-- users.js        //Роут пользователей (регистрация), --//--
|   |
|   +-- src                 //Frontend проекта
|   |   +-- actions
|   |   |   +-- AuthActions.js
|   |   |   +-- ListActions.js
|   |   +-- components
|   |   |   +-- Auth.js
|   |   |   +-- List.js
|   |   |   +-- Login.js
|   |   |   +-- Registration.js
|   |   |   +-- TodoItem.js
|   |   +-- constants
|   |   |   +-- Auth.js
|   |   |   +-- List.js
|   |   +-- containers
|   |   |   +-- App.js
|   |   +-- reducers
|   |   |   +-- auth.js
|   |   |   +-- list.js
|   |   +-- store
|   |   |   +-- configureStore.js
|   |   +-- index.js         //Точка входа в Frontend
|   |   +-- style.scss
|   +-- public               //Директория со сборкой нашего фронтенда,
|   |   |                    //генерируемая webpack из ./src
|   |   +-- index.js
|   |   +-- style.css
|   +-- views                //Шаблоны
|   |   +-- error.pug        //Грузится, если при запросе страницы приложения ошибка
|   |   +-- index.pug        //Грузится при успешной обработке страницы приложения
|   |   |                    //Подключает фронтенд из ./public и работает, как SPA
|   |   +-- layout.pug
|   +-- server.config.json   //Конфиг сервера, содержит секретный ключ сессий
|   |                        //и настройки Redis
|   +-- server.js            //Сам сервер (express app)
+-- helpers                  //Общие вспомогательные модули
|   +-- normalize-port.js
+-- .babelrc                 //Дополнительный конфиг для babel
+-- .eslint                  //Конфиг для линтера
+-- .gitignore
+-- .sequelizerc             //Конфиг для sequelize-cli, который проводит миграции БД
+-- index.js                 //Точка входа в проект, инициализирует и запускает оба
|                            //(API и Middle-end) сервера
+-- package.json
+-- README.MD
+-- webpack.config.js
```

Т.о., приложение состоит из 3 частей - API-сервер, middle-end-сервер и frontend.
API-сервер расположен в папке ./api, для общения с базой данных (PostgreSQL) использует
Sequelize ORM, и включает в себя две модели - Todo и User.
Для аутентификации используется passport (Local Strategy), на middle-end отсылается
сгенерированный JWT веб-токен.
Роуты построены по REST-архитектуре, представляя собой ресурсы todo, session, user
(хотя ни один из ресурсов не имеет полного набора rest-методов).
Точкой входа является server.js, содержащий express-приложение.

Middle-end-сервер расположен в папке ./app, также содержит роуты для 3 ресурсов
(todo, session, user), но, помимо них, имеет роут index. Этот роут используется при
запросе страницы приложения, загружает шаблон с фронтендом и начальное состояние SPA,
проверив, авторизован пользователь или нет.
При авторизации и аутентификации сервер приложения получает JSON web-токены с API-сервера,
а с клиентом устанавливает сессию. Сессии хранятся в Redis в виде (session-key : token).

Весь Frontend хранится в поддиректории middle-end-сервера ./app/src.
По архитектуре он представляет из себя типичное React/Redux приложение.
Внутри контейнера на верхнем уровне крепятся компоненты List и Auth. В Store хранится,
в том числе, и  имя пользователя (list.user). Если user не пустой (не null), то будет
отрисован компонент List, если null - компонент Auth.
Компонент Auth является вспомогательным, а нём отрисовывается компонент Login или
Registration, что меняется изменением состояния auth.status (переключаем по ссылке).
Компонент List содержит список компонент Todo.
При изменении (удалении, редактировании дел) списка в случае успеха с сервера возвращается
список всех дел пользователя целиком и устанавливается в состояние. Можно было обойтись
без этого, не нарушая RESTfull характер серверов, не заставляя 'дополнительно' дёргать
дела из базы данных и отправлять их через сервера на клиент. Можно было бы просто запомнить
изменения, сделанные пользователем, на клиенте, и сохранить при статусе ответа 200 их
состояние. Но сделано именно так на случай, если пользователь сидит с нескольких устройств
одновременно и меняет список (хотя, на самом деле, такое маловероятно).

Весь фронтенд пакуется в ./app/public с помощью webpack.

Шаблоны тоже хранятся в поддиректории middle-сервера. По-сути, у нас один шаблон,
который загружается при любом удачном запросе страницы приложения, и один шаблон
для ошибок.

В корне хранятся общие конфиги и точка входа во всё наше приложение - index.js.
В index.js содержится инициализация и запуск обоих серверов (по умолчанию, API
на порту :3500 и middle-end-сервер на порту :8000)


##Настройка и запуск приложения
1. Установить все зависимости, выполнив в директории приложения:
   `npm install`
2. Необходимо прописать свои собственные конфиги: секретный ключ для генерации токенов
в ./api/server.config.json, настройки БД PostgreSQL в ./api/config.json,
секретный ключ для сессий и настройки Redis в ./app/server.config.json
3. Выполнить миграции. В директории приложения:
   `sequelize db:migrate`
Если возникли какие-либо ошибки, возможно, неправильно настроена база данных. Нужно проверить
./api/config.json
4. Пакуем фронтенд. Для production выполнить в корневой директории приложения:
   `NODE_ENV=production webpack`
   Получим сжатый код без source-map.
   Для dev-окружения просто `webpack`
5. Запускаем приложение.
   Для dev-окружения: `npm start`.
   Можно указать порты серверов с помощью PORT_API и PORT_APP
   Для запуска в production будем использовать [pm2](https://github.com/Unitech/pm2)
   Установить pm2 можно с помощью npm: `sudo npm i -g pm2`
   Запускаем наше приложение:
   `NODE_ENV=production pm2 start index.js`
